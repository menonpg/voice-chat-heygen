<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HeyGen Custom Avatar Chat</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
      }
      .container {
          background: white;
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          max-width: 900px;
          width: 100%;
      }
      h1 {
          text-align: center;
          color: #333;
          margin-bottom: 20px;
          font-size: 28px;
      }
      #avatar-container {
          width: 100%;
          height: 500px;
          background: #000;
          border-radius: 15px;
          margin: 20px 0;
          position: relative;
          overflow: hidden;
      }
      #avatar-video {
          width: 100%;
          height: 100%;
          object-fit: cover;
      }
      .status-bar {
          padding: 15px;
          margin: 15px 0;
          border-radius: 10px;
          background: #e3f2fd;
          color: #1976d2;
          text-align: center;
          font-weight: 500;
      }
      .status-bar.error {
          background: #ffebee;
          color: #c62828;
      }
      .status-bar.success {
          background: #e8f5e9;
          color: #2e7d32;
      }
      .controls {
          display: flex;
          gap: 10px;
          margin: 20px 0;
          flex-wrap: wrap;
          justify-content: center;
      }
      button {
          padding: 15px 30px;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          transition: all 0.3s;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      button:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      }
      button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }
      .btn-start {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }
      .btn-stop {
          background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
          color: white;
      }
      .btn-voice {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white;
          font-size: 20px;
          padding: 20px 40px;
      }
      .btn-voice.recording {
          background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
          animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.05); }
      }
      .transcript {
          background: #f5f5f5;
          border-radius: 10px;
          padding: 15px;
          margin: 20px 0;
          min-height: 60px;
          max-height: 150px;
          overflow-y: auto;
      }
      .transcript-label {
          font-weight: 600;
          color: #666;
          margin-bottom: 8px;
      }
      .transcript-text {
          color: #333;
          font-size: 16px;
          line-height: 1.5;
      }
      .config-section {
          background: #f9f9f9;
          padding: 15px;
          border-radius: 10px;
          margin: 20px 0;
          font-size: 14px;
      }
      .config-section input {
          width: 100%;
          padding: 8px;
          margin: 5px 0;
          border: 1px solid #ddd;
          border-radius: 5px;
          font-family: monospace;
      }
      .config-section label {
          font-weight: 600;
          color: #555;
          display: block;
          margin-top: 10px;
      }
  </style>
</head>
<body>
  <div class="container">
      <h1>üé≠ Talk to Your Custom Avatar</h1>
      
      <div class="config-section">
          <label>HeyGen API Key:</label>
          <input type="password" id="apiKey" placeholder="Enter your API key">
          
          <label>Avatar ID:</label>
          <input type="text" id="avatarId" placeholder="Enter your custom avatar ID">
          
          <label>Voice ID:</label>
          <input type="text" id="voiceId" placeholder="Enter your cloned voice ID">
      </div>
      
      <div id="status" class="status-bar">Configure your settings above and click Start</div>
      
      <div id="avatar-container">
          <video id="avatar-video" autoplay playsinline></video>
      </div>
      
      <div class="controls">
          <button id="startBtn" class="btn-start">üöÄ Start Session</button>
          <button id="stopBtn" class="btn-stop" disabled>‚èπÔ∏è Stop Session</button>
      </div>

      <div class="controls">
          <button id="voiceBtn" class="btn-voice" disabled>üé§ Click & Speak</button>
      </div>

      <div class="transcript">
          <div class="transcript-label">You said:</div>
          <div id="transcriptText" class="transcript-text">Your speech will appear here...</div>
      </div>
  </div>

  <script>
      // State
      let sessionId = null;
      let peerConnection = null;
      let recognition = null;
      let isRecording = false;

      // DOM Elements
      const apiKeyInput = document.getElementById('apiKey');
      const avatarIdInput = document.getElementById('avatarId');
      const voiceIdInput = document.getElementById('voiceId');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const voiceBtn = document.getElementById('voiceBtn');
      const status = document.getElementById('status');
      const avatarVideo = document.getElementById('avatar-video');
      const transcriptText = document.getElementById('transcriptText');

      // Initialize Web Speech API
      function initSpeechRecognition() {
          if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
              updateStatus('Speech recognition not supported in this browser. Use Chrome or Edge.', 'error');
              return false;
          }

          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'en-US';

          recognition.onresult = async (event) => {
              const transcript = event.results[0][0].transcript;
              transcriptText.textContent = transcript;
              updateStatus('Processing your message...', 'success');
              await sendTextToAvatar(transcript);
          };

          recognition.onerror = (event) => {
              console.error('Speech recognition error:', event.error);
              updateStatus('Speech recognition error: ' + event.error, 'error');
              voiceBtn.classList.remove('recording');
              voiceBtn.textContent = 'üé§ Click & Speak';
              isRecording = false;
          };

          recognition.onend = () => {
              voiceBtn.classList.remove('recording');
              voiceBtn.textContent = 'üé§ Click & Speak';
              isRecording = false;
          };

          return true;
      }

      // Update status
      function updateStatus(message, type = 'info') {
          status.textContent = message;
          status.className = 'status-bar';
          if (type === 'error') status.classList.add('error');
          if (type === 'success') status.classList.add('success');
      }

      // Start HeyGen session
      async function startSession() {
          const apiKey = apiKeyInput.value.trim();
          const avatarId = avatarIdInput.value.trim();
          const voiceId = voiceIdInput.value.trim();

          if (!apiKey || !avatarId || !voiceId) {
              updateStatus('Please fill in all configuration fields', 'error');
              return;
          }

          try {
              updateStatus('Starting session with your custom avatar...');

              const response = await fetch('https://api.heygen.com/v1/streaming.new', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-Api-Key': apiKey
                  },
                  body: JSON.stringify({
                      avatar_id: avatarId,
                      voice: {
                          voice_id: voiceId
                      },
                      quality: 'high',
                      version: 'v2'
                  })
              });

              if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.message || 'Failed to start session');
              }

              const data = await response.json();
              
              if (data.data && data.data.session_id) {
                  sessionId = data.data.session_id;
                  await setupWebRTC(data.data);
                  
                  if (initSpeechRecognition()) {
                      updateStatus('‚úÖ Ready! Click the microphone to speak', 'success');
                      startBtn.disabled = true;
                      stopBtn.disabled = false;
                      voiceBtn.disabled = false;
                  }
              } else {
                  throw new Error('Invalid response from HeyGen API');
              }
          } catch (error) {
              updateStatus('Error: ' + error.message, 'error');
              console.error('Session error:', error);
          }
      }

      // Setup WebRTC
      async function setupWebRTC(sessionData) {
          const { sdp: serverSdp, ice_servers2: iceServers } = sessionData;

          peerConnection = new RTCPeerConnection({
              iceServers: iceServers || [
                  { urls: 'stun:stun.l.google.com:19302' }
              ]
          });

          peerConnection.ontrack = (event) => {
              if (event.streams && event.streams[0]) {
                  avatarVideo.srcObject = event.streams[0];
              }
          };

          peerConnection.oniceconnectionstatechange = () => {
              console.log('ICE connection state:', peerConnection.iceConnectionState);
          };

          // Set remote description
          await peerConnection.setRemoteDescription(
              new RTCSessionDescription({ type: 'offer', sdp: serverSdp })
          );

          // Create answer
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);

          // Send answer to HeyGen
          const apiKey = apiKeyInput.value.trim();
          await fetch('https://api.heygen.com/v1/streaming.start', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-Api-Key': apiKey
              },
              body: JSON.stringify({
                  session_id: sessionId,
                  sdp: answer.sdp
              })
          });
      }

      // Send text to avatar
      async function sendTextToAvatar(text) {
          if (!sessionId || !text) return;

          try {
              const apiKey = apiKeyInput.value.trim();
              
              const response = await fetch('https://api.heygen.com/v1/streaming.task', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-Api-Key': apiKey
                  },
                  body: JSON.stringify({
                      session_id: sessionId,
                      text: text,
                      task_type: 'talk'
                  })
              });

              if (!response.ok) {
                  throw new Error('Failed to send message');
              }

              updateStatus('üó£Ô∏è Avatar is speaking...', 'success');
              
              // Reset after a delay
              setTimeout(() => {
                  updateStatus('Ready for next message', 'success');
              }, 3000);
          } catch (error) {
              updateStatus('Error sending message: ' + error.message, 'error');
              console.error(error);
          }
      }

      // Toggle voice recording
      function toggleVoiceRecording() {
          if (!recognition) return;

          if (isRecording) {
              recognition.stop();
          } else {
              isRecording = true;
              voiceBtn.classList.add('recording');
              voiceBtn.textContent = 'üî¥ Listening...';
              updateStatus('Listening... Speak now!', 'success');
              recognition.start();
          }
      }

      // Stop session
      async function stopSession() {
          try {
              if (sessionId) {
                  const apiKey = apiKeyInput.value.trim();
                  await fetch('https://api.heygen.com/v1/streaming.stop', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'X-Api-Key': apiKey
                      },
                      body: JSON.stringify({ session_id: sessionId })
                  });
              }

              if (peerConnection) {
                  peerConnection.close();
                  peerConnection = null;
              }

              if (recognition && isRecording) {
                  recognition.stop();
              }

              sessionId = null;
              avatarVideo.srcObject = null;
              transcriptText.textContent = 'Your speech will appear here...';
              
              startBtn.disabled = false;
              stopBtn.disabled = true;
              voiceBtn.disabled = true;
              
              updateStatus('Session ended. Configure and start again.');
          } catch (error) {
              updateStatus('Error stopping session: ' + error.message, 'error');
              console.error(error);
          }
      }

      // Event listeners
      startBtn.addEventListener('click', startSession);
      stopBtn.addEventListener('click', stopSession);
      voiceBtn.addEventListener('click', toggleVoiceRecording);

      // Save config to localStorage
      apiKeyInput.addEventListener('change', () => {
          localStorage.setItem('heygen_api_key', apiKeyInput.value);
      });
      avatarIdInput.addEventListener('change', () => {
          localStorage.setItem('heygen_avatar_id', avatarIdInput.value);
      });
      voiceIdInput.addEventListener('change', () => {
          localStorage.setItem('heygen_voice_id', voiceIdInput.value);
      });

      // Load saved config
      window.addEventListener('load', () => {
          apiKeyInput.value = localStorage.getItem('heygen_api_key') || '';
          avatarIdInput.value = localStorage.getItem('heygen_avatar_id') || '';
          voiceIdInput.value = localStorage.getItem('heygen_voice_id') || '';
      });
  </script>
</body>
</html>